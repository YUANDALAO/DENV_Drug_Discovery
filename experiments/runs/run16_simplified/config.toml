# Run16_simplified: 简化版三阶段优化配置
# 只使用REINVENT4确认支持的参数

run_type = "staged_learning"
device = "cuda:0"
tb_logdir = "experiments/runs/run16_simplified/tensorboard"
json_out_config = "experiments/runs/run16_simplified/run16_simplified.json"

[parameters]
summary_csv_prefix = "experiments/runs/run16_simplified/results"
use_checkpoint = false
purge_memories = false

# 模型配置
prior_file = "priors/libinvent.prior"
agent_file = "priors/denv_libinvent_model_v2.model"
smiles_file = "data/pyrrolidine_dual_aryl.smi"

batch_size = 32
unique_sequences = true
randomize_smiles = false

# 全局学习策略
[learning_strategy]
type = "dap"
sigma = 120
rate = 0.0001

# 全局多样性过滤器
[diversity_filter]
type = "IdenticalMurckoScaffold"
bucket_size = 25
minscore = 0.5

# Inception配置
[inception]
smiles_file = "data/pyrrolidine_dual_aryl.smi"
memory_size = 30
sample_size = 3

# ============================================
# Stage 1: 探索阶段
# ============================================
[[stage]]
max_score = 0.70
min_steps = 800
max_steps = 2000
chkpt_file = "experiments/runs/run16_simplified/run16_stage1.chkpt"

[stage.scoring]
type = "arithmetic_mean"

# QSAR活性评分
[[stage.scoring.component]]
[stage.scoring.component.QSARScorer]
[[stage.scoring.component.QSARScorer.endpoint]]
name = "DENV_Activity"
weight = 2.0

[stage.scoring.component.QSARScorer.endpoint.params]
model_path = "/mnt/c/Users/ucsaheu/python_projects/DENV_Drug_Discovery/02_ML_Modeling/models/random_forest_champion.joblib"

[stage.scoring.component.QSARScorer.endpoint.transform]
type = "sigmoid"
low = 6.0
high = 8.0
k = 2.0

# 立体中心
[[stage.scoring.component]]
[stage.scoring.component.NumAtomStereoCenters]
[[stage.scoring.component.NumAtomStereoCenters.endpoint]]
name = "Stereo_Centers"
weight = 0.6

[stage.scoring.component.NumAtomStereoCenters.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 3
k = 1.0

# 结构警报
[[stage.scoring.component]]
[stage.scoring.component.CustomAlerts]
[[stage.scoring.component.CustomAlerts.endpoint]]
name = "Stability_Alerts"
weight = 1.0

[stage.scoring.component.CustomAlerts.endpoint.params]
smarts = [
    "[*;r8]",
    "[*;r9]",
    "[*;r10]",
    "[#8][#8]",
    "[#6;+]",
    "C#C",
    "[NX3][NX3]",
    "[SH]",
    "[N+](=O)[O-]"
]

# QED
[[stage.scoring.component]]
[stage.scoring.component.Qed]
[[stage.scoring.component.Qed.endpoint]]
name = "QED"
weight = 0.3

# 合成可行性
[[stage.scoring.component]]
[stage.scoring.component.SAScore]
[[stage.scoring.component.SAScore.endpoint]]
name = "SA"
weight = 0.4

[stage.scoring.component.SAScore.endpoint.transform]
type = "reverse_sigmoid"
low = 1.0
high = 5.5
k = 0.8

# 分子量
[[stage.scoring.component]]
[stage.scoring.component.MolecularWeight]
[[stage.scoring.component.MolecularWeight.endpoint]]
name = "MW"
weight = 0.5

[stage.scoring.component.MolecularWeight.endpoint.transform]
type = "double_sigmoid"
low = 250.0
high = 600.0
coef_div = 600.0
coef_si = 15.0
coef_se = 15.0

# 重原子数
[[stage.scoring.component]]
[stage.scoring.component.NumHeavyAtoms]
[[stage.scoring.component.NumHeavyAtoms.endpoint]]
name = "Heavy_Atoms"
weight = 0.4

[stage.scoring.component.NumHeavyAtoms.endpoint.transform]
type = "double_sigmoid"
low = 18
high = 45
coef_div = 45.0
coef_si = 5.0
coef_se = 5.0

# LogP
[[stage.scoring.component]]
[stage.scoring.component.SlogP]
[[stage.scoring.component.SlogP.endpoint]]
name = "LogP"
weight = 0.3

[stage.scoring.component.SlogP.endpoint.transform]
type = "double_sigmoid"
low = 0.5
high = 5.0
coef_div = 5.0
coef_si = 10.0
coef_se = 10.0

# TPSA
[[stage.scoring.component]]
[stage.scoring.component.TPSA]
[[stage.scoring.component.TPSA.endpoint]]
name = "TPSA"
weight = 0.2

[stage.scoring.component.TPSA.endpoint.transform]
type = "double_sigmoid"
low = 30.0
high = 120.0
coef_div = 120.0
coef_si = 20.0
coef_se = 20.0

# 氢键受体
[[stage.scoring.component]]
[stage.scoring.component.HBondAcceptors]
[[stage.scoring.component.HBondAcceptors.endpoint]]
name = "HBA"
weight = 0.3

[stage.scoring.component.HBondAcceptors.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 8
k = 0.5

# 氢键供体
[[stage.scoring.component]]
[stage.scoring.component.HBondDonors]
[[stage.scoring.component.HBondDonors.endpoint]]
name = "HBD"
weight = 0.2

[stage.scoring.component.HBondDonors.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 4
k = 0.5

# 可旋转键
[[stage.scoring.component]]
[stage.scoring.component.NumRotBond]
[[stage.scoring.component.NumRotBond.endpoint]]
name = "Rotatable_Bonds"
weight = 0.2

[stage.scoring.component.NumRotBond.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 9
k = 0.5

# 环数量
[[stage.scoring.component]]
[stage.scoring.component.NumRings]
[[stage.scoring.component.NumRings.endpoint]]
name = "Ring_Count"
weight = 0.2

[stage.scoring.component.NumRings.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 5
k = 0.5

# 芳香环
[[stage.scoring.component]]
[stage.scoring.component.NumAromaticRings]
[[stage.scoring.component.NumAromaticRings.endpoint]]
name = "Aromatic_Rings"
weight = 0.15

[stage.scoring.component.NumAromaticRings.endpoint.transform]
type = "reverse_sigmoid"
low = 1
high = 3
k = 0.5

# ============================================
# Stage 2: 优化阶段（提高活性权重）
# ============================================
[[stage]]
max_score = 0.85
min_steps = 1000
max_steps = 3500
chkpt_file = "experiments/runs/run16_simplified/checkpoints/run16_stage2.chkpt"

[stage.scoring]
type = "arithmetic_mean"

# QSAR活性评分（提高权重和阈值）
[[stage.scoring.component]]
[stage.scoring.component.QSARScorer]
[[stage.scoring.component.QSARScorer.endpoint]]
name = "DENV_Activity"
weight = 3.0

[stage.scoring.component.QSARScorer.endpoint.params]
model_path = "/mnt/c/Users/ucsaheu/python_projects/DENV_Drug_Discovery/02_ML_Modeling/models/random_forest_champion.joblib"

[stage.scoring.component.QSARScorer.endpoint.transform]
type = "sigmoid"
low = 7.5
high = 9.0
k = 2.5

# 其他组件复制Stage1配置（省略以节省空间）
# 复制所有其他组件...

[[stage.scoring.component]]
[stage.scoring.component.NumAtomStereoCenters]
[[stage.scoring.component.NumAtomStereoCenters.endpoint]]
name = "Stereo_Centers"
weight = 0.6

[stage.scoring.component.NumAtomStereoCenters.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 3
k = 1.0

[[stage.scoring.component]]
[stage.scoring.component.CustomAlerts]
[[stage.scoring.component.CustomAlerts.endpoint]]
name = "Stability_Alerts"
weight = 1.0

[stage.scoring.component.CustomAlerts.endpoint.params]
smarts = [
    "[*;r8]",
    "[*;r9]",
    "[*;r10]",
    "[#8][#8]",
    "[#6;+]",
    "C#C",
    "[NX3][NX3]",
    "[SH]",
    "[N+](=O)[O-]"
]

[[stage.scoring.component]]
[stage.scoring.component.Qed]
[[stage.scoring.component.Qed.endpoint]]
name = "QED"
weight = 0.3

[[stage.scoring.component]]
[stage.scoring.component.SAScore]
[[stage.scoring.component.SAScore.endpoint]]
name = "SA"
weight = 0.4

[stage.scoring.component.SAScore.endpoint.transform]
type = "reverse_sigmoid"
low = 1.0
high = 5.5
k = 0.8

[[stage.scoring.component]]
[stage.scoring.component.MolecularWeight]
[[stage.scoring.component.MolecularWeight.endpoint]]
name = "MW"
weight = 0.5

[stage.scoring.component.MolecularWeight.endpoint.transform]
type = "double_sigmoid"
low = 250.0
high = 600.0
coef_div = 600.0
coef_si = 15.0
coef_se = 15.0

[[stage.scoring.component]]
[stage.scoring.component.NumHeavyAtoms]
[[stage.scoring.component.NumHeavyAtoms.endpoint]]
name = "Heavy_Atoms"
weight = 0.4

[stage.scoring.component.NumHeavyAtoms.endpoint.transform]
type = "double_sigmoid"
low = 18
high = 45
coef_div = 45.0
coef_si = 5.0
coef_se = 5.0

[[stage.scoring.component]]
[stage.scoring.component.SlogP]
[[stage.scoring.component.SlogP.endpoint]]
name = "LogP"
weight = 0.3

[stage.scoring.component.SlogP.endpoint.transform]
type = "double_sigmoid"
low = 0.5
high = 5.0
coef_div = 5.0
coef_si = 10.0
coef_se = 10.0

[[stage.scoring.component]]
[stage.scoring.component.TPSA]
[[stage.scoring.component.TPSA.endpoint]]
name = "TPSA"
weight = 0.2

[stage.scoring.component.TPSA.endpoint.transform]
type = "double_sigmoid"
low = 30.0
high = 120.0
coef_div = 120.0
coef_si = 20.0
coef_se = 20.0

[[stage.scoring.component]]
[stage.scoring.component.HBondAcceptors]
[[stage.scoring.component.HBondAcceptors.endpoint]]
name = "HBA"
weight = 0.3

[stage.scoring.component.HBondAcceptors.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 8
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.HBondDonors]
[[stage.scoring.component.HBondDonors.endpoint]]
name = "HBD"
weight = 0.2

[stage.scoring.component.HBondDonors.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 4
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.NumRotBond]
[[stage.scoring.component.NumRotBond.endpoint]]
name = "Rotatable_Bonds"
weight = 0.2

[stage.scoring.component.NumRotBond.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 9
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.NumRings]
[[stage.scoring.component.NumRings.endpoint]]
name = "Ring_Count"
weight = 0.2

[stage.scoring.component.NumRings.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 5
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.NumAromaticRings]
[[stage.scoring.component.NumAromaticRings.endpoint]]
name = "Aromatic_Rings"
weight = 0.15

[stage.scoring.component.NumAromaticRings.endpoint.transform]
type = "reverse_sigmoid"
low = 1
high = 3
k = 0.5