# Run13c: Reward Shaping优化版
# 核心改进：Sigmoid transform + 降低sigma/learning rate + 两阶段强化
# 基于：run13b的成功架构 + reward engineering优化

run_type = "staged_learning"
device = "cuda:0"
tb_logdir = "experiments/runs/run13c/tensorboard"
json_out_config = "experiments/runs/run13c/_config.json"

[parameters]
summary_csv_prefix = "experiments/runs/run13c/results"
use_checkpoint = true
purge_memories = false

# 使用V2预训练模型（与run13b相同）
prior_file = "priors/libinvent.prior"
agent_file = "priors/denv_libinvent_model_v2.model"  
smiles_file = "data/pyrrolidine_dual_aryl.smi"

batch_size = 32              # 保持不变：适配4GB显存
unique_sequences = true
randomize_smiles = false

[learning_strategy]
type = "dap"
sigma = 60                   # ✅ 改动1：从120降至60（增强高分敏感度）
rate = 0.00003               # ✅ 改动2：从0.0001降至0.00003（稳定学习）

[diversity_filter]
type = "IdenticalMurckoScaffold"
bucket_size = 100            # ✅ 改动3：从25增至100（允许更多探索）
minscore = 0.50              # 保持不变

[inception]
smiles_file = "data/pyrrolidine_dual_aryl.smi"
memory_size = 30             # 保持不变
sample_size = 3              # 保持不变

# ============================================
# ✅ 改动4：分为两个Stage（渐进式强化）
# Stage 1: 探索阶段（目标0.70）
# ============================================
[[stage]]
max_score = 0.70             # ✅ 第一阶段目标降低（从0.80→0.70）
min_steps = 800              # ✅ 减少（从1500→800）
max_steps = 2000             # ✅ 减少（从6000→2000）
chkpt_file = "experiments/runs/run13c/checkpoint_stage1.chkpt"

[stage.scoring]
type = "arithmetic_mean"     # 保持不变：与run13b一致

# ========================================
# 第一优先级：活性（核心改动）
# ========================================
[[stage.scoring.component]]
[stage.scoring.component.QSARScorer]
[[stage.scoring.component.QSARScorer.endpoint]]
name = "DENV_Activity"
weight = 2.0                 # ✅ 改动5：从2.5降至2.0（Stage1探索期）
[stage.scoring.component.QSARScorer.endpoint.params]
model_path = "/mnt/c/Users/ucsaheu/python_projects/DENV_Drug_Discovery/02_ML_Modeling/models/random_forest_champion.joblib"

# ✅ 改动6：关键！使用Sigmoid替代double_sigmoid
[stage.scoring.component.QSARScorer.endpoint.transform]
type = "sigmoid"             # 从double_sigmoid改为sigmoid
low = 7.0                    # 新增：pIC50下限
high = 8.5                   # 新增：pIC50上限
k = 2.0                      # 新增：陡峭度

# ========================================
# 其余组分：完全保持run13b设置
# ========================================

[[stage.scoring.component]]
[stage.scoring.component.NumAtomStereoCenters]
[[stage.scoring.component.NumAtomStereoCenters.endpoint]]
name = "Stereo_Centers"
weight = 0.6
[stage.scoring.component.NumAtomStereoCenters.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 3
k = 1.0

[[stage.scoring.component]]
[stage.scoring.component.CustomAlerts]
[[stage.scoring.component.CustomAlerts.endpoint]]
name = "Stability_Alerts"
weight = 1.0
[stage.scoring.component.CustomAlerts.endpoint.params]
smarts = [
    "[*;r8]", "[*;r9]", "[*;r10]",
    "[#8][#8]", "[#6;+]", "C#C",
    "[NX3][NX3]", "[SH]", "[N+](=O)[O-]",
    "S(=O)(=O)Cl", "[F,Cl,Br,I][C,c][F,Cl,Br,I]",
    "c1ccc2c(c1)C(=O)c1c(C2=O)cccc1",
    "C1=CC(=O)C=CC1=O",
    "[C;R1]1[C;R1][C;R1][N;R1][C;R1]1([!#1])([!#1])([!#1])",
    "[C;R1]1[C;R1]([!#1])([!#1])[C;R1]([!#1])([!#1])[N;R1][C;R1]1",
]

[[stage.scoring.component]]
[stage.scoring.component.Qed]
[[stage.scoring.component.Qed.endpoint]]
name = "QED"
weight = 0.3

[[stage.scoring.component]]
[stage.scoring.component.SAScore]
[[stage.scoring.component.SAScore.endpoint]]
name = "SA"
weight = 0.4
[stage.scoring.component.SAScore.endpoint.transform]
type = "reverse_sigmoid"
low = 1.0
high = 5.5
k = 0.8

[[stage.scoring.component]]
[stage.scoring.component.MolecularWeight]
[[stage.scoring.component.MolecularWeight.endpoint]]
name = "MW"
weight = 0.5
[stage.scoring.component.MolecularWeight.endpoint.transform]
type = "double_sigmoid"
low = 250.0
high = 600.0
coef_div = 600.0
coef_si = 15.0
coef_se = 15.0

[[stage.scoring.component]]
[stage.scoring.component.NumHeavyAtoms]
[[stage.scoring.component.NumHeavyAtoms.endpoint]]
name = "Heavy_Atoms"
weight = 0.4
[stage.scoring.component.NumHeavyAtoms.endpoint.transform]
type = "double_sigmoid"
low = 18
high = 45
coef_div = 45.0
coef_si = 5.0
coef_se = 5.0

[[stage.scoring.component]]
[stage.scoring.component.SlogP]
[[stage.scoring.component.SlogP.endpoint]]
name = "LogP"
weight = 0.3
[stage.scoring.component.SlogP.endpoint.transform]
type = "double_sigmoid"
low = 0.5
high = 5.0
coef_div = 5.0
coef_si = 10.0
coef_se = 10.0

[[stage.scoring.component]]
[stage.scoring.component.TPSA]
[[stage.scoring.component.TPSA.endpoint]]
name = "TPSA"
weight = 0.2
[stage.scoring.component.TPSA.endpoint.transform]
type = "double_sigmoid"
low = 30.0
high = 120.0
coef_div = 120.0
coef_si = 20.0
coef_se = 20.0

[[stage.scoring.component]]
[stage.scoring.component.HBondAcceptors]
[[stage.scoring.component.HBondAcceptors.endpoint]]
name = "HBA"
weight = 0.3
[stage.scoring.component.HBondAcceptors.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 8
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.HBondDonors]
[[stage.scoring.component.HBondDonors.endpoint]]
name = "HBD"
weight = 0.2
[stage.scoring.component.HBondDonors.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 4
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.NumRotBond]
[[stage.scoring.component.NumRotBond.endpoint]]
name = "Rotatable_Bonds"
weight = 0.2
[stage.scoring.component.NumRotBond.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 9
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.NumRings]
[[stage.scoring.component.NumRings.endpoint]]
name = "Ring_Count"
weight = 0.2
[stage.scoring.component.NumRings.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 5
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.NumAromaticRings]
[[stage.scoring.component.NumAromaticRings.endpoint]]
name = "Aromatic_Rings"
weight = 0.15
[stage.scoring.component.NumAromaticRings.endpoint.transform]
type = "reverse_sigmoid"
low = 1
high = 3
k = 0.5

# ============================================
# ✅ 改动7：新增Stage 2（优化阶段）
# Stage 2: 聚焦高活性（目标0.85）
# ============================================
[[stage]]
max_score = 0.85             # 更高目标
min_steps = 1000
max_steps = 3500             # 总计5500步（2000+3500）
chkpt_file = "experiments/runs/run13c/checkpoint_stage2.chkpt"

[stage.scoring]
type = "arithmetic_mean"

# ========================================
# Stage 2：提高QSAR权重+更严格标准
# ========================================
[[stage.scoring.component]]
[stage.scoring.component.QSARScorer]
[[stage.scoring.component.QSARScorer.endpoint]]
name = "DENV_Activity"
weight = 3.0                 # ✅ 改动8：从2.0提升至3.0（Stage2强化）
[stage.scoring.component.QSARScorer.endpoint.params]
model_path = "/mnt/c/Users/ucsaheu/python_projects/DENV_Drug_Discovery/02_ML_Modeling/models/random_forest_champion.joblib"

# ✅ 改动9：Stage2更严格的transform
[stage.scoring.component.QSARScorer.endpoint.transform]
type = "sigmoid"
low = 7.5                    # 提高下限（从7.0→7.5）
high = 9.0                   # 提高上限（从8.5→9.0）
k = 2.5                      # 更陡峭（从2.0→2.5）

# ========================================
# Stage 2：其余组分复制Stage 1
# ========================================

[[stage.scoring.component]]
[stage.scoring.component.NumAtomStereoCenters]
[[stage.scoring.component.NumAtomStereoCenters.endpoint]]
name = "Stereo_Centers"
weight = 0.6
[stage.scoring.component.NumAtomStereoCenters.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 3
k = 1.0

[[stage.scoring.component]]
[stage.scoring.component.CustomAlerts]
[[stage.scoring.component.CustomAlerts.endpoint]]
name = "Stability_Alerts"
weight = 1.0
[stage.scoring.component.CustomAlerts.endpoint.params]
smarts = [
    "[*;r8]", "[*;r9]", "[*;r10]",
    "[#8][#8]", "[#6;+]", "C#C",
    "[NX3][NX3]", "[SH]", "[N+](=O)[O-]",
    "S(=O)(=O)Cl", "[F,Cl,Br,I][C,c][F,Cl,Br,I]",
    "c1ccc2c(c1)C(=O)c1c(C2=O)cccc1",
    "C1=CC(=O)C=CC1=O",
    "[C;R1]1[C;R1][C;R1][N;R1][C;R1]1([!#1])([!#1])([!#1])",
    "[C;R1]1[C;R1]([!#1])([!#1])[C;R1]([!#1])([!#1])[N;R1][C;R1]1",
]

[[stage.scoring.component]]
[stage.scoring.component.Qed]
[[stage.scoring.component.Qed.endpoint]]
name = "QED"
weight = 0.3

[[stage.scoring.component]]
[stage.scoring.component.SAScore]
[[stage.scoring.component.SAScore.endpoint]]
name = "SA"
weight = 0.4
[stage.scoring.component.SAScore.endpoint.transform]
type = "reverse_sigmoid"
low = 1.0
high = 5.5
k = 0.8

[[stage.scoring.component]]
[stage.scoring.component.MolecularWeight]
[[stage.scoring.component.MolecularWeight.endpoint]]
name = "MW"
weight = 0.5
[stage.scoring.component.MolecularWeight.endpoint.transform]
type = "double_sigmoid"
low = 250.0
high = 600.0
coef_div = 600.0
coef_si = 15.0
coef_se = 15.0

[[stage.scoring.component]]
[stage.scoring.component.NumHeavyAtoms]
[[stage.scoring.component.NumHeavyAtoms.endpoint]]
name = "Heavy_Atoms"
weight = 0.4
[stage.scoring.component.NumHeavyAtoms.endpoint.transform]
type = "double_sigmoid"
low = 18
high = 45
coef_div = 45.0
coef_si = 5.0
coef_se = 5.0

[[stage.scoring.component]]
[stage.scoring.component.SlogP]
[[stage.scoring.component.SlogP.endpoint]]
name = "LogP"
weight = 0.3
[stage.scoring.component.SlogP.endpoint.transform]
type = "double_sigmoid"
low = 0.5
high = 5.0
coef_div = 5.0
coef_si = 10.0
coef_se = 10.0

[[stage.scoring.component]]
[stage.scoring.component.TPSA]
[[stage.scoring.component.TPSA.endpoint]]
name = "TPSA"
weight = 0.2
[stage.scoring.component.TPSA.endpoint.transform]
type = "double_sigmoid"
low = 30.0
high = 120.0
coef_div = 120.0
coef_si = 20.0
coef_se = 20.0

[[stage.scoring.component]]
[stage.scoring.component.HBondAcceptors]
[[stage.scoring.component.HBondAcceptors.endpoint]]
name = "HBA"
weight = 0.3
[stage.scoring.component.HBondAcceptors.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 8
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.HBondDonors]
[[stage.scoring.component.HBondDonors.endpoint]]
name = "HBD"
weight = 0.2
[stage.scoring.component.HBondDonors.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 4
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.NumRotBond]
[[stage.scoring.component.NumRotBond.endpoint]]
name = "Rotatable_Bonds"
weight = 0.2
[stage.scoring.component.NumRotBond.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 9
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.NumRings]
[[stage.scoring.component.NumRings.endpoint]]
name = "Ring_Count"
weight = 0.2
[stage.scoring.component.NumRings.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 5
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.NumAromaticRings]
[[stage.scoring.component.NumAromaticRings.endpoint]]
name = "Aromatic_Rings"
weight = 0.15
[stage.scoring.component.NumAromaticRings.endpoint.transform]
type = "reverse_sigmoid"
low = 1
high = 3
k = 0.5