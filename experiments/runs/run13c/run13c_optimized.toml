# Run13c_optimized: 基于最成功配置的优化版本
# 核心策略：低sigma + 极低学习率 + 大bucket_size + sigmoid transform
# 预期成功率：> 0.08%

run_type = "staged_learning"
device = "cuda:0"
tb_logdir = "tensorboard/run13c_optimized"
json_out_config = "configs/run13c_optimized.json"

[parameters]
summary_csv_prefix = "results/run13c_optimized"
restart_dir = "checkpoints/run13c_optimized"
use_checkpoint = true
purge_memories = false

# 模型配置
prior_file = "priors/libinvent.prior"
agent_file = "priors/denv_libinvent_model_v2.model"  
smiles_file = "data/pyrrolidine_dual_aryl.smi"

# 生成参数
batch_size = 32
unique_sequences = true
randomize_smiles = false

# 日志配置
save_frequency = 100
logging_frequency = 50
checkpoint_frequency = 500

[learning_strategy]
type = "dap"
sigma = 60                   # 低值：高度聚焦高活性区域
rate = 0.00003              # 极低：精细参数调整

[diversity_filter]
type = "ScaffoldSimilarity"  # 改进：使用相似性而非完全相同
bucket_size = 100            # 大值：允许深度探索优势骨架
minscore = 0.50
minsimilarity = 0.4          # 允许相似骨架

[inception]
smiles_file = "data/pyrrolidine_dual_aryl.smi"
memory_size = 50             # 增加：记住更多高分分子
sample_size = 5

# ============================================
# Stage 1: 探索阶段（快速识别活性区域）
# ============================================
[[stage]]
max_score = 0.70
min_steps = 800
max_steps = 2000
chkpt_file = "checkpoints/run13c_optimized/stage1.chkpt"

[stage.learning_strategy]
type = "dap"
sigma = 80                   # Stage1稍高，增加探索
rate = 0.00005

[stage.scoring]
type = "arithmetic_mean"

# QSAR活性评分（核心）
[[stage.scoring.component]]
[stage.scoring.component.QSARScorer]
[[stage.scoring.component.QSARScorer.endpoint]]
name = "DENV_Activity"
weight = 2.0                 # Stage1适中权重

[stage.scoring.component.QSARScorer.endpoint.params]
model_path = "models/denv_qsar_model.pkl"

[stage.scoring.component.QSARScorer.endpoint.transform]
type = "sigmoid"
low = 6.5
high = 8.0
k = 2.0

# 立体中心控制
[[stage.scoring.component]]
[stage.scoring.component.NumAtomStereoCenters]
[[stage.scoring.component.NumAtomStereoCenters.endpoint]]
name = "Stereo_Centers"
weight = 0.6

[stage.scoring.component.NumAtomStereoCenters.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 3
k = 1.0

# 结构警报过滤
[[stage.scoring.component]]
[stage.scoring.component.CustomAlerts]
[[stage.scoring.component.CustomAlerts.endpoint]]
name = "Stability_Alerts"
weight = 1.0

[stage.scoring.component.CustomAlerts.endpoint.params]
smarts = [
    "[*;r8]", "[*;r9]", "[*;r10]",
    "[#8][#8]", "[#6;+]", "C#C",
    "[NX3][NX3]", "[SH]", "[N+](=O)[O-]",
    "S(=O)(=O)Cl", "[F,Cl,Br,I][C,c][F,Cl,Br,I]",
]

# QED药物相似性
[[stage.scoring.component]]
[stage.scoring.component.Qed]
[[stage.scoring.component.Qed.endpoint]]
name = "QED"
weight = 0.3

# 合成可行性
[[stage.scoring.component]]
[stage.scoring.component.SAScore]
[[stage.scoring.component.SAScore.endpoint]]
name = "SA"
weight = 0.4

[stage.scoring.component.SAScore.endpoint.transform]
type = "reverse_sigmoid"
low = 1.0
high = 5.5
k = 0.8

# 分子量
[[stage.scoring.component]]
[stage.scoring.component.MolecularWeight]
[[stage.scoring.component.MolecularWeight.endpoint]]
name = "MW"
weight = 0.5

[stage.scoring.component.MolecularWeight.endpoint.transform]
type = "double_sigmoid"
low = 300.0
high = 550.0
coef_div = 425.0
coef_si = 20.0
coef_se = 20.0

# 重原子数
[[stage.scoring.component]]
[stage.scoring.component.NumHeavyAtoms]
[[stage.scoring.component.NumHeavyAtoms.endpoint]]
name = "Heavy_Atoms"
weight = 0.4

[stage.scoring.component.NumHeavyAtoms.endpoint.transform]
type = "double_sigmoid"
low = 20
high = 40
coef_div = 30.0
coef_si = 5.0
coef_se = 5.0

# LogP
[[stage.scoring.component]]
[stage.scoring.component.SlogP]
[[stage.scoring.component.SlogP.endpoint]]
name = "LogP"
weight = 0.3

[stage.scoring.component.SlogP.endpoint.transform]
type = "double_sigmoid"
low = 2.0
high = 4.5
coef_div = 3.25
coef_si = 15.0
coef_se = 15.0

# TPSA
[[stage.scoring.component]]
[stage.scoring.component.TPSA]
[[stage.scoring.component.TPSA.endpoint]]
name = "TPSA"
weight = 0.2

[stage.scoring.component.TPSA.endpoint.transform]
type = "double_sigmoid"
low = 40.0
high = 100.0
coef_div = 70.0
coef_si = 20.0
coef_se = 20.0

# 氢键受体
[[stage.scoring.component]]
[stage.scoring.component.HBondAcceptors]
[[stage.scoring.component.HBondAcceptors.endpoint]]
name = "HBA"
weight = 0.3

[stage.scoring.component.HBondAcceptors.endpoint.transform]
type = "reverse_sigmoid"
low = 3
high = 7
k = 0.5

# 氢键供体
[[stage.scoring.component]]
[stage.scoring.component.HBondDonors]
[[stage.scoring.component.HBondDonors.endpoint]]
name = "HBD"
weight = 0.2

[stage.scoring.component.HBondDonors.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 3
k = 0.5

# 可旋转键
[[stage.scoring.component]]
[stage.scoring.component.NumRotBond]
[[stage.scoring.component.NumRotBond.endpoint]]
name = "Rotatable_Bonds"
weight = 0.2

[stage.scoring.component.NumRotBond.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 7
k = 0.5

# 环系统
[[stage.scoring.component]]
[stage.scoring.component.NumRings]
[[stage.scoring.component.NumRings.endpoint]]
name = "Ring_Count"
weight = 0.2

[stage.scoring.component.NumRings.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 4
k = 0.5

# 芳香环
[[stage.scoring.component]]
[stage.scoring.component.NumAromaticRings]
[[stage.scoring.component.NumAromaticRings.endpoint]]
name = "Aromatic_Rings"
weight = 0.15

[stage.scoring.component.NumAromaticRings.endpoint.transform]
type = "reverse_sigmoid"
low = 1
high = 3
k = 0.5

# ============================================
# Stage 2: 聚焦优化（深度探索高活性区域）
# ============================================
[[stage]]
max_score = 0.85
min_steps = 1500
max_steps = 4000
chkpt_file = "checkpoints/run13c_optimized/stage2.chkpt"

[stage.learning_strategy]
type = "dap"
sigma = 60                   # 回到最优值
rate = 0.00003              # 极低学习率

[stage.scoring]
type = "arithmetic_mean"

# QSAR活性评分（提高权重）
[[stage.scoring.component]]
[stage.scoring.component.QSARScorer]
[[stage.scoring.component.QSARScorer.endpoint]]
name = "DENV_Activity"
weight = 3.0                 # Stage2提高权重

[stage.scoring.component.QSARScorer.endpoint.params]
model_path = "models/denv_qsar_model.pkl"

[stage.scoring.component.QSARScorer.endpoint.transform]
type = "sigmoid"
low = 7.5                    # 提高阈值
high = 9.0
k = 2.5                      # 更陡峭

# 复制其他组件配置（省略以节省空间，实际使用时需要完整复制）
# ... [其他组件配置同Stage1，但可以微调权重]

# ============================================
# 监控配置
# ============================================
[monitoring]
metrics = [
    "mean_score",
    "mean_pIC50",
    "unique_scaffolds",
    "qed_mean",
    "sa_mean",
    "validity_rate"
]
log_frequency = 50
save_best_molecules = true
best_molecules_file = "results/run13c_optimized/best_molecules.smi"

# ============================================
# TensorBoard配置
# ============================================
[tensorboard]
enabled = true
log_dir = "tensorboard/run13c_optimized"
log_frequency = 50
log_histograms = true
log_gradients = false
log_images = true
log_graph = false

# ============================================
# 输出配置
# ============================================
[output]
save_frequency = 500
save_format = ["smi", "csv", "sdf"]
save_scores = true
save_metadata = true
compress = true