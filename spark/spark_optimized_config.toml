# ============================================================================
# REINVENT4 LibInvent Configuration - NVIDIA DGX Spark Optimized
# ============================================================================
# Hardware: 128GB unified memory, GB10 GPU, 20 ARM cores
# Target: Generate 2.5M molecules in 8-12 hours
# Scaffold: Pyrrolidine dual aromatic for DENV NS2B-NS3 protease inhibitors
# ============================================================================

run_type = "staged_learning"
device = "cuda:0"
tb_logdir = "experiments/runs/spark_run1/tensorboard"
json_out_config = "experiments/runs/spark_run1/_config.json"

[parameters]
summary_csv_prefix = "experiments/runs/spark_run1/results"
use_checkpoint = true
purge_memories = false

# Model files
prior_file = "priors/libinvent.prior"
agent_file = "priors/denv_libinvent_model.model"
smiles_file = "data/pyrrolidine_dual_aryl.smi"

# ============================================
# DGX Spark Optimization: 大幅提升批次大小
# ============================================
batch_size = 512              # 从32提升16倍到512（充分利用128GB内存）
unique_sequences = true
randomize_smiles = true       # 启用SMILES随机化增加多样性

[learning_strategy]
type = "dap"
sigma = 60                    # 使用你验证过的最优值
rate = 0.00015                # 根据大batch size调整学习率（0.0001 × 1.5）

[diversity_filter]
type = "IdenticalMurckoScaffold"
bucket_size = 15              # 降低至15以保持多样性（from 25）
minscore = 0.6                # 稍微提高以过滤低质量分子

[inception]
smiles_file = "data/pyrrolidine_dual_aryl.smi"
memory_size = 100             # 增加到100（充分利用内存）
sample_size = 20              # 增加到20（更好的replay memory）

# ============================================
# Stage 1: 主要生成阶段
# ============================================
[[stage]]
max_score = 0.85              # 稍微提高目标分数
min_steps = 1000              # 最少1000步确保训练充分
max_steps = 5000              # 5000步 × 512 batch = 2,560,000 molecules!
chkpt_file = "experiments/runs/spark_run1/checkpoint_stage1.chkpt"

[stage.scoring]
type = "arithmetic_mean"      # 使用算术平均（更平衡）

# ========================================
# 优先级1: DENV活性预测 (最高权重)
# ========================================
[[stage.scoring.component]]
[stage.scoring.component.QSARScorer]

[[stage.scoring.component.QSARScorer.endpoint]]
name = "DENV_Activity"
weight = 3.0                  # 提高到3.0强化活性驱动

[stage.scoring.component.QSARScorer.endpoint.params]
model_path = "models/random_forest_champion.joblib"

[stage.scoring.component.QSARScorer.endpoint.transform]
type = "double_sigmoid"
low = 4.5                     # 稍微提高阈值
high = 9.0
coef_div = 9.0
coef_si = 8.0
coef_se = 8.0

# ========================================
# 优先级2: 化学稳定性
# ========================================

[[stage.scoring.component]]
[stage.scoring.component.NumAtomStereoCenters]

[[stage.scoring.component.NumAtomStereoCenters.endpoint]]
name = "Stereo_Centers"
weight = 0.6

[stage.scoring.component.NumAtomStereoCenters.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 3
k = 1.0

[[stage.scoring.component]]
[stage.scoring.component.CustomAlerts]

[[stage.scoring.component.CustomAlerts.endpoint]]
name = "Stability_Alerts"
weight = 1.2                  # 提高到1.2（确保稳定性）

[stage.scoring.component.CustomAlerts.endpoint.params]
smarts = [
    "[*;r8]", "[*;r9]", "[*;r10]", "[*;r11]",
    "[#8][#8]",
    "[#6;+]",
    "C#C",
    "[NX3][NX3]",
    "[SH]",
    "[N+](=O)[O-]",
    "S(=O)(=O)Cl",
    "[F,Cl,Br,I][C,c][F,Cl,Br,I]",
    "c1ccc2c(c1)C(=O)c1c(C2=O)cccc1",
    "C1=CC(=O)C=CC1=O",
]

# ========================================
# 优先级3: 类药性
# ========================================

[[stage.scoring.component]]
[stage.scoring.component.Qed]

[[stage.scoring.component.Qed.endpoint]]
name = "QED"
weight = 0.4                  # 提高到0.4

[[stage.scoring.component]]
[stage.scoring.component.SAScore]

[[stage.scoring.component.SAScore.endpoint]]
name = "SA"
weight = 0.5                  # 提高到0.5（强化可合成性）

[stage.scoring.component.SAScore.endpoint.transform]
type = "reverse_sigmoid"
low = 1.0
high = 5.0                    # 降低到5.0（更严格）
k = 0.8

# ========================================
# 优先级4: 物理化学性质
# ========================================

[[stage.scoring.component]]
[stage.scoring.component.MolecularWeight]

[[stage.scoring.component.MolecularWeight.endpoint]]
name = "MW"
weight = 0.5

[stage.scoring.component.MolecularWeight.endpoint.transform]
type = "double_sigmoid"
low = 280.0                   # 稍微提高下限
high = 550.0                  # 降低上限（更严格）
coef_div = 550.0
coef_si = 15.0
coef_se = 15.0

[[stage.scoring.component]]
[stage.scoring.component.NumHeavyAtoms]

[[stage.scoring.component.NumHeavyAtoms.endpoint]]
name = "Heavy_Atoms"
weight = 0.4

[stage.scoring.component.NumHeavyAtoms.endpoint.transform]
type = "double_sigmoid"
low = 20                      # 提高下限
high = 42                     # 降低上限
coef_div = 42.0
coef_si = 5.0
coef_se = 5.0

[[stage.scoring.component]]
[stage.scoring.component.SlogP]

[[stage.scoring.component.SlogP.endpoint]]
name = "LogP"
weight = 0.4                  # 提高权重

[stage.scoring.component.SlogP.endpoint.transform]
type = "double_sigmoid"
low = 1.0                     # 提高下限
high = 4.5                    # 降低上限
coef_div = 4.5
coef_si = 10.0
coef_se = 10.0

[[stage.scoring.component]]
[stage.scoring.component.TPSA]

[[stage.scoring.component.TPSA.endpoint]]
name = "TPSA"
weight = 0.3

[stage.scoring.component.TPSA.endpoint.transform]
type = "double_sigmoid"
low = 40.0
high = 110.0
coef_div = 110.0
coef_si = 20.0
coef_se = 20.0

[[stage.scoring.component]]
[stage.scoring.component.HBondAcceptors]

[[stage.scoring.component.HBondAcceptors.endpoint]]
name = "HBA"
weight = 0.3

[stage.scoring.component.HBondAcceptors.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 8
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.HBondDonors]

[[stage.scoring.component.HBondDonors.endpoint]]
name = "HBD"
weight = 0.2

[stage.scoring.component.HBondDonors.endpoint.transform]
type = "reverse_sigmoid"
low = 0
high = 4
k = 0.5

# ========================================
# 优先级5: 结构复杂度
# ========================================

[[stage.scoring.component]]
[stage.scoring.component.NumRotBond]

[[stage.scoring.component.NumRotBond.endpoint]]
name = "Rotatable_Bonds"
weight = 0.25

[stage.scoring.component.NumRotBond.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 8
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.NumRings]

[[stage.scoring.component.NumRings.endpoint]]
name = "Ring_Count"
weight = 0.2

[stage.scoring.component.NumRings.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 5
k = 0.5

[[stage.scoring.component]]
[stage.scoring.component.NumAromaticRings]

[[stage.scoring.component.NumAromaticRings.endpoint]]
name = "Aromatic_Rings"
weight = 0.2

[stage.scoring.component.NumAromaticRings.endpoint.transform]
type = "reverse_sigmoid"
low = 2
high = 4
k = 0.5

# ============================================================================
# 配置说明：
# - Batch size 512: 充分利用128GB内存，约是T1200(32)的16倍
# - Max steps 5000: 预计生成 5000 × 512 = 2,560,000 个分子
# - 预期运行时间: 8-12小时（vs T1200的24小时）
# - Diversity filter优化: bucket_size=15保持高多样性
# - Learning rate调整: 0.00015（根据大batch size调整）
# - Inception增强: memory_size=100, sample_size=20
# ============================================================================
